<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprinkler Modification Work Permit</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
        body { background-color: #f5f5f5; padding: 20px; max-width: 800px; margin: 0 auto; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* FIRE RED COLOR (#d32f2f) for important elements */
        h1 { 
            color: #d32f2f; 
            text-align: center; 
            margin-bottom: 20px; 
            border-bottom: 2px solid #d32f2f; 
            padding-bottom: 10px; 
        }
        
        /* GREEN COLOR (#0d6a4e) for advisory box */
        .advisory-box { 
            background-color: #e8f5e9; 
            border-left: 4px solid #0d6a4e; 
            padding: 15px; 
            margin: 20px 0; 
            font-size: 14px; 
        }
        .advisory-box h3 { 
            color: #0d6a4e; 
            margin-bottom: 10px; 
        }
        
        /* FIRE RED for required fields */
        .required::after { 
            content: " *"; 
            color: #d32f2f; 
            font-weight: bold; 
        }
        
        .status-message { padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: center; display: none; }
        .error { background-color: #ffebee; color: #d32f2f; border: 1px solid #d32f2f; }
        .success { background-color: #e8f5e9; color: #0d6a4e; border: 1px solid #0d6a4e; }
        .processing { background-color: #fff3e0; color: #ef6c00; border: 1px solid #ef6c00; }
        
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        
        input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select { 
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; 
        }
        
        /* Make date field look disabled */
        input[type="date"]:disabled {
            background-color: #f5f5f5;
            color: #666;
        }
        
        .checkbox-group { margin: 15px 0; }
        .checkbox-row { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        
        .signature-pad { 
            border: 2px solid #ddd; 
            height: 150px; 
            width: 100%; 
            margin: 10px 0; 
            background-color: white;
            border-radius: 4px;
        }
        
        .signature-controls { 
            margin: 10px 0; 
            display: flex; 
            gap: 10px; 
        }
        .signature-controls button { 
            padding: 8px 16px; 
            background-color: #f5f5f5; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold;
        }
        .signature-controls button:hover { 
            background-color: #e0e0e0; 
        }
        
        /* FIRE RED for submit button */
        button#submitBtn { 
            background-color: #d32f2f; 
            color: white; 
            padding: 15px 30px; 
            border: none; 
            border-radius: 5px; 
            font-size: 18px; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 20px; 
            font-weight: bold; 
        }
        button#submitBtn:hover { 
            background-color: #b71c1c; 
        }
        button#submitBtn:disabled { 
            background-color: #cccccc; 
            cursor: not-allowed; 
        }
        
        .footer-note { text-align: center; margin-top: 20px; color: #666; font-size: 14px; font-style: italic; }
        
        .error-message { 
            color: #d32f2f; 
            font-size: 12px; 
            margin-top: 5px; 
            display: none; 
            font-weight: bold;
        }
        
        /* Sync section styling */
        .sync-section { 
            background: #e8f5e9; 
            padding: 15px; 
            border-radius: 8px; 
            border: 2px solid #0d6a4e; 
            margin: 20px 0; 
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sprinkler Modification Work Permit</h1>
        
        <div id="syncSection" class="sync-section">
            <p id="syncStatus">Connecting to system...</p>
        </div>
        
        <div id="statusMessage" class="status-message"></div>
        
        <form id="sprinklerForm">
            <p><strong>File Safety Compliance Form</strong></p>
            
            <h2>Work Permit Details</h2>
            
            <table>
                <tr>
                    <th class="required">Scroll No</th>
                    <th class="required">Date</th>
                    <th class="required">Tower</th>
                </tr>
                <tr>
                    <!-- AUTO-GENERATED SCROLL NUMBER -->
                    <td><input type="text" id="scroll_no" name="scroll_no" readonly style="background-color: #f5f5f5; font-weight: bold;"></td>
                    
                    <!-- TODAY'S DATE (UNEDITABLE) -->
                    <td><input type="date" id="date" name="date" readonly disabled></td>
                    
                    <td>
                        <select id="tower" name="tower" required>
                            <option value="">Select Tower</option>
                            <option value="Tower A">Tower A</option>
                            <option value="Tower B">Tower B</option>
                            <option value="Tower C">Tower C</option>
                            <option value="Tower D">Tower D</option>
                        </select>
                    </td>
                </tr>
            </table>
            
            <div class="form-group">
                <label for="flat_no" class="required">Flat No.</label>
                <input type="text" id="flat_no" name="flat_no" placeholder="e.g., 10F, 15B" required>
            </div>
            
            <div class="form-group">
                <label for="owner_name" class="required">Owner Name</label>
                <input type="text" id="owner_name" name="owner_name" required>
            </div>
            
            <div class="form-group">
                <label for="contact_number" class="required">Contact Number</label>
                <input type="tel" id="contact_number" name="contact_number" pattern="[0-9]{10}" placeholder="10-digit number" required>
                <div class="error-message" id="contactError">Please enter a valid 10-digit phone number</div>
            </div>
            
            <!-- EMAIL IS NOW OPTIONAL -->
            <div class="form-group">
                <label for="email">Email Address (Optional)</label>
                <input type="email" id="email" name="email" placeholder="Optional">
                <div class="error-message" id="emailError">Please enter a valid email address</div>
            </div>
            
            <!-- UPDATED LOCATIONS -->
            <div class="checkbox-group">
                <label class="required">Sprinkler Extension Required At</label>
                <div class="checkbox-row">
                    <label class="checkbox-item"><input type="checkbox" name="extension_location" value="HALL"> HALL</label>
                    <label class="checkbox-item"><input type="checkbox" name="extension_location" value="DINING"> DINING</label>
                    <label class="checkbox-item"><input type="checkbox" name="extension_location" value="MBR"> MBR</label>
                    <label class="checkbox-item"><input type="checkbox" name="extension_location" value="CBR"> CBR</label>
                    <label class="checkbox-item"><input type="checkbox" name="extension_location" value="GBR"> GBR</label>
                </div>
            </div>
            
            <div class="advisory-box">
                <h3>Note & Advisory</h3>
                <p><strong>Important Information:</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>The Fire sprinklers along with related fire system pipelines, Smoke Detectors with related wiring provided inside the flat for Fire Safety are neither to be tampered with nor modified nor concealed above the false ceiling while carrying out the interior works.</li>
                    <li>Owners are to insist with their interior vendors for integration of the original setup of fire sprinkler and smoke detection systems as provided by the builder into the interior design in line with guidelines mentioned herein.</li>
                    <li>The owner is to obtain prior clearance from PMS if he still has to make such modifications for which neither TeamMyIn nor PMS bears any responsibility for any damages whatsoever caused thereafter either to self property, neighbours or common area property.</li>
                    <li>You are hereby advised not to carry out any modification works with respect to the fire sprinklers and smoke detectors provided by the builder. Since this is a high-rise building, fire safety shall be given utmost priority over aesthetics. If modifications are still chosen, the owner shall engage only the original vendor who executed the firefighting work.</li>
                </ul>
            </div>
            
            <div class="checkbox-group">
                <label class="checkbox-item">
                    <input type="checkbox" id="advisory_acknowledged" name="advisory_acknowledged" required>
                    <span class="required">I have read and understood the above Note & Advisory</span>
                </label>
            </div>
            
            <div class="form-group">
                <label class="required">Signature of Owner</label>
                <div id="signaturePad" class="signature-pad"></div>
                <div class="signature-controls">
                    <!-- CLEAR AND SAVE BUTTONS ALWAYS VISIBLE -->
                    <button type="button" id="clearSignature">‚úñÔ∏è CLEAR Signature</button>
                    <button type="button" id="saveSignature">üíæ SAVE Signature</button>
                </div>
                <div class="error-message" id="signatureError">Please provide your signature</div>
            </div>
            
            <!-- SUBMIT BUTTON WITH CORRECT TEXT -->
            <button type="button" id="submitBtn">Submit Form & Send Email</button>
            
            <p class="footer-note">
                This form ensures compliance with the safety regulations.<br>
                Form data will be logged to Google Sheets and emailed to facilities@team4lifespaces.com
            </p>
        </form>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        // üîß IMPORTANT: Replace with YOUR Google Script URL
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzerGqTIsKtCCgobgK_cSNxBCNXhI8gOyvaS2wIrFkip_vGSrJnuMzzkHqpVewwRs0Ivw/exec";
        
        // Global variables
        let signaturePad;
        let googleScriptUrl = GOOGLE_SCRIPT_URL;
        let formCounter = 1; // For auto-generating scroll numbers
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // 1. AUTO-GENERATE SCROLL NUMBER (Format: SPR-001, SPR-002, etc.)
            const today = new Date();
            const dateStr = today.getDate().toString().padStart(2, '0') + 
                           (today.getMonth()+1).toString().padStart(2, '0') + 
                           today.getFullYear().toString().slice(2);
            
            // Get counter from localStorage or start from 1
            const storedCounter = localStorage.getItem('form_counter');
            formCounter = storedCounter ? parseInt(storedCounter) : 1;
            
            // Generate scroll number: SPR-YYYYMMDD-001
            const scrollNumber = `SPR-${dateStr}-${formCounter.toString().padStart(3, '0')}`;
            document.getElementById('scroll_no').value = scrollNumber;
            
            // 2. SET TODAY'S DATE (uneditable)
            const todayISO = today.toISOString().split('T')[0];
            document.getElementById('date').value = todayISO;
            
            // 3. INITIALIZE SIGNATURE PAD
            const canvas = document.createElement('canvas');
            canvas.width = document.getElementById('signaturePad').offsetWidth;
            canvas.height = 150;
            document.getElementById('signaturePad').appendChild(canvas);
            
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'white',
                penColor: '#d32f2f', // Fire red color for signature
                minWidth: 1,
                maxWidth: 3
            });
            
            // 4. TEST GOOGLE SCRIPT CONNECTION
            testGoogleConnection();
        });
        
        // ============================================
        // GOOGLE SCRIPT CONNECTION
        // ============================================
        
        async function testGoogleConnection() {
            document.getElementById('syncStatus').textContent = 'üîó Testing connection...';
            
            try {
                const response = await fetch(googleScriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: true })
                });
                
                if (response.ok) {
                    document.getElementById('syncStatus').textContent = '‚úÖ Connected to Google Sheets & Email System';
                    setTimeout(() => {
                        document.getElementById('syncSection').style.display = 'none';
                    }, 2000);
                } else {
                    document.getElementById('syncStatus').textContent = '‚ö†Ô∏è Connection issue. Form will still work locally.';
                }
            } catch (error) {
                document.getElementById('syncStatus').textContent = '‚ö†Ô∏è Cannot connect to server. PDF will still be generated.';
                console.log('Connection test failed (expected for CORS):', error);
            }
        }
        
        // ============================================
        // SIGNATURE HANDLING
        // ============================================
        
        // Clear signature
        document.getElementById('clearSignature').addEventListener('click', () => {
            signaturePad.clear();
            document.getElementById('signatureError').style.display = 'none';
        });
        
        // Save signature
        document.getElementById('saveSignature').addEventListener('click', () => {
            if (signaturePad.isEmpty()) {
                showError('Please sign first before saving');
                return;
            }
            showMessage('‚úì Signature saved', 'success');
        });
        
        // ============================================
        // FORM VALIDATION & DATA HANDLING
        // ============================================
        
        function getFormData() {
            const checkboxes = document.querySelectorAll('input[name="extension_location"]:checked');
            const locations = Array.from(checkboxes).map(cb => cb.value);
            
            return {
                scroll_no: document.getElementById('scroll_no').value,
                date: document.getElementById('date').value,
                tower: document.getElementById('tower').value,
                flat_no: document.getElementById('flat_no').value,
                owner_name: document.getElementById('owner_name').value,
                contact_number: document.getElementById('contact_number').value,
                email: document.getElementById('email').value || '', // Optional, can be empty
                extension_locations: locations.join(', '),
                advisory_acknowledged: document.getElementById('advisory_acknowledged').checked,
                signature: signaturePad.isEmpty() ? null : signaturePad.toDataURL(),
                timestamp: new Date().toLocaleString()
            };
        }
        
        // FIXED: Email is now optional
        function validateForm(data) {
            if (!data.flat_no.trim()) {
                showError('Please enter Flat No.');
                return false;
            }
            if (!data.owner_name.trim()) {
                showError('Please enter Owner Name');
                return false;
            }
            if (!data.contact_number || !/^[0-9]{10}$/.test(data.contact_number)) {
                showError('Please enter a valid 10-digit Contact Number');
                return false;
            }
            // EMAIL IS OPTIONAL - only validate if provided
            if (data.email && data.email.trim() !== '' && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
                showError('Please enter a valid email address or leave it blank');
                return false;
            }
            if (!data.tower) {
                showError('Please select a Tower');
                return false;
            }
            if (!data.signature) {
                showError('Please provide your signature');
                return false;
            }
            if (!data.advisory_acknowledged) {
                showError('Please acknowledge the Note & Advisory');
                return false;
            }
            return true;
        }
        
        // ============================================
        // MESSAGE HANDLING
        // ============================================
        
        function showMessage(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status-message ' + type;
            statusEl.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
            }
        }
        
        function showError(message) {
            showMessage(message, 'error');
        }
        
        // ============================================
        // PDF GENERATION
        // ============================================
        
        async function generatePDF(data) {
            return new Promise((resolve) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    
                    // Title in FIRE RED
                    doc.setFontSize(16);
                    doc.setTextColor(211, 47, 47); // #d32f2f
                    doc.text('Sprinkler Modification Work Permit', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text('File Safety Compliance Form', 105, 27, { align: 'center' });
                    
                    // Work Permit Details
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Work Permit Details', 20, 40);
                    
                    doc.autoTable({
                        startY: 45,
                        head: [['Scroll No', 'Date', 'Tower']],
                        body: [[data.scroll_no, data.date, data.tower]],
                        theme: 'grid'
                    });
                    
                    // Owner Information
                    let y = doc.autoTable.previous.finalY + 15;
                    doc.text('Owner Information:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.text(`Flat No: ${data.flat_no}`, 20, y);
                    y += 7;
                    doc.text(`Owner: ${data.owner_name}`, 20, y);
                    y += 7;
                    doc.text(`Contact: ${data.contact_number}`, 20, y);
                    y += 7;
                    if (data.email) {
                        doc.text(`Email: ${data.email}`, 20, y);
                        y += 7;
                    }
                    y += 5;
                    
                    // Extension Locations
                    doc.setFontSize(12);
                    doc.text('Sprinkler Extension Required At:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    const locations = data.extension_locations || 'None selected';
                    doc.text(locations, 20, y);
                    
                    // Save PDF
                    const pdfBase64 = doc.output('datauristring').split(',')[1];
                    
                    resolve({
                        success: true,
                        pdfBase64: pdfBase64,
                        pdfBlob: doc.output('blob'),
                        doc: doc
                    });
                    
                } catch (error) {
                    console.error('PDF generation error:', error);
                    resolve({
                        success: false,
                        error: error.message
                    });
                }
            });
        }
        
        // ============================================
        // FORM SUBMISSION TO GOOGLE SCRIPT
        // ============================================
        
        async function submitToGoogleScript(data, pdfBase64) {
            showMessage('Sending form data to Google Sheets...', 'processing');
            
            try {
                const payload = {
                    ...data,
                    pdf_base64: pdfBase64 || null,
                    form_id: data.scroll_no
                };
                
                const response = await fetch(googleScriptUrl, {
                    method: 'POST',
                    mode: 'no-cors', // Important for CORS issues
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                // With 'no-cors' mode, we can't read response, but submission works
                return {
                    success: true,
                    message: '‚úì Form submitted! Email sent to facilities@team4lifespaces.com'
                };
                
            } catch (error) {
                console.error('Submission error:', error);
                return {
                    success: false,
                    message: '‚ö†Ô∏è Form submitted locally. Server connection failed.'
                };
            }
        }
        
        // ============================================
        // MAIN SUBMIT HANDLER
        // ============================================
        
        document.getElementById('submitBtn').addEventListener('click', async function() {
            const btn = this;
            const formData = getFormData();
            
            // Validate form
            if (!validateForm(formData)) {
                return;
            }
            
            // Disable button and show processing
            btn.disabled = true;
            btn.textContent = 'Processing...';
            
            try {
                // Step 1: Generate PDF
                showMessage('Generating PDF...', 'processing');
                const pdfResult = await generatePDF(formData);
                
                if (!pdfResult.success) {
                    throw new Error('PDF generation failed');
                }
                
                // Step 2: Submit to Google Script
                const submitResult = await submitToGoogleScript(formData, pdfResult.pdfBase64);
                
                // Step 3: Show result
                showMessage(submitResult.message, submitResult.success ? 'success' : 'error');
                
                // Step 4: Auto-download PDF for user
                if (pdfResult.pdfBlob) {
                    const url = URL.createObjectURL(pdfResult.pdfBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Sprinkler_Permit_${formData.flat_no}_${formData.scroll_no}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
                
                // Step 5: Increment counter for next form
                formCounter++;
                localStorage.setItem('form_counter', formCounter.toString());
                
                // Step 6: Reset form after delay
                setTimeout(() => {
                    document.getElementById('sprinklerForm').reset();
                    signaturePad.clear();
                    
                    // Generate new scroll number for next form
                    const today = new Date();
                    const dateStr = today.getDate().toString().padStart(2, '0') + 
                                   (today.getMonth()+1).toString().padStart(2, '0') + 
                                   today.getFullYear().toString().slice(2);
                    const newScrollNumber = `SPR-${dateStr}-${formCounter.toString().padStart(3, '0')}`;
                    document.getElementById('scroll_no').value = newScrollNumber;
                    
                    // Reset date to today
                    document.getElementById('date').value = today.toISOString().split('T')[0];
                    
                    btn.disabled = false;
                    btn.textContent = 'Submit Form & Send Email';
                }, 3000);
                
            } catch (error) {
                console.error('Submission error:', error);
                showMessage('‚ùå Error: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'Submit Form & Send Email';
            }
        });
        
        // ============================================
        // FORM FIELD VALIDATION (REAL-TIME)
        // ============================================
        
        // Phone number validation
        document.getElementById('contact_number').addEventListener('input', function(e) {
            const phoneRegex = /^[0-9]{10}$/;
            if (!phoneRegex.test(e.target.value)) {
                document.getElementById('contactError').style.display = 'block';
            } else {
                document.getElementById('contactError').style.display = 'none';
            }
        });
        
        // Email validation (only if provided)
        document.getElementById('email').addEventListener('input', function(e) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (e.target.value.trim() !== '' && !emailRegex.test(e.target.value)) {
                document.getElementById('emailError').style.display = 'block';
            } else {
                document.getElementById('emailError').style.display = 'none';
            }
        });
    </script>
</body>
</html>
