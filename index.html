<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprinkler Modification Work Permit</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        /* All CSS styles from previous solution - keep them */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
        body { background-color: #f5f5f5; padding: 20px; max-width: 800px; margin: 0 auto; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        h1 { color: #d32f2f; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #d32f2f; padding-bottom: 10px; }
        .status-message { padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: center; display: none; }
        .error { background-color: #ffebee; color: #d32f2f; }
        .success { background-color: #e8f5e9; color: #2e7d32; }
        .processing { background-color: #fff3e0; color: #ef6c00; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .required::after { content: " *"; color: #d32f2f; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select { 
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; 
        }
        .checkbox-group { margin: 15px 0; }
        .checkbox-row { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        .advisory-box { background-color: #fff3e0; border-left: 4px solid #ff9800; padding: 15px; margin: 20px 0; font-size: 14px; }
        .signature-pad { border: 2px dashed #ddd; height: 150px; width: 100%; margin: 10px 0; cursor: crosshair; background-color: white; }
        .signature-controls { margin: 10px 0; display: flex; gap: 10px; }
        .signature-controls button { padding: 8px 16px; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
        button { background-color: #d32f2f; color: white; padding: 15px 30px; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; width: 100%; margin-top: 20px; font-weight: bold; }
        button:hover { background-color: #b71c1c; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        .footer-note { text-align: center; margin-top: 20px; color: #666; font-size: 14px; font-style: italic; }
        .sync-section { background: #f0f7ff; padding: 20px; border-radius: 8px; border: 2px dashed #4a90e2; margin: 20px 0; text-align: center; }
        .sync-section h3 { color: #4a90e2; margin-bottom: 15px; }
        .google-btn { background: white; color: #444; border: 1px solid #ddd; padding: 12px 24px; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; font-weight: bold; }
        .google-btn:hover { background: #f8f8f8; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sprinkler Modification Work Permit</h1>
        
        <!-- Sync with Google Section (Will disappear after setup) -->
        <div id="syncSection" class="sync-section">
            <h3>ðŸ“Š Connect to Google Sheets & Email</h3>
            <p>Click below to set up automatic email and Google Sheets logging.</p>
            <button id="syncButton" class="google-btn" onclick="setupGoogleSync()">
                <span>ðŸ”— Sync with Google Sheet</span>
            </button>
            <p style="margin-top: 10px; font-size: 12px; color: #666;">
                This will connect the form to send emails from vaidyaajith12@gmail.com
            </p>
        </div>
        
        <div id="statusMessage" class="status-message"></div>
        
        <form id="sprinklerForm" style="display: none;">
            <p><strong>File Safety Compliance Form</strong></p>
            
            <h2>Work Permit Details</h2>
            
            <table>
                <tr>
                    <th class="required">Scroll No</th>
                    <th class="required">Date</th>
                    <th class="required">Tower</th>
                </tr>
                <tr>
                    <td><input type="text" id="scroll_no" name="scroll_no" value="001" required></td>
                    <td><input type="date" id="date" name="date" required></td>
                    <td>
                        <select id="tower" name="tower" required>
                            <option value="">Select Tower</option>
                            <option value="Tower A">Tower A</option>
                            <option value="Tower B">Tower B</option>
                            <option value="Tower C">Tower C</option>
                            <option value="Tower D">Tower D</option>
                        </select>
                    </td>
                </tr>
            </table>
            
            <div class="form-group">
                <label for="flat_no" class="required">Flat No.</label>
                <input type="text" id="flat_no" name="flat_no" placeholder="e.g., 10F, 15B" required>
            </div>
            
            <div class="form-group">
                <label for="owner_name" class="required">Owner Name</label>
                <input type="text" id="owner_name" name="owner_name" required>
            </div>
            
            <div class="form-group">
                <label for="contact_number" class="required">Contact Number</label>
                <input type="tel" id="contact_number" name="contact_number" pattern="[0-9]{10}" placeholder="10-digit number" required>
            </div>
            
            <div class="form-group">
                <label for="email" class="required">Email Address</label>
                <input type="email" id="email" name="email" required>
            </div>
            
            <div class="checkbox-group">
                <label class="required">Sprinkler Extension Required At</label>
                <div class="checkbox-row">
                    <label class="checkbox-item"><input type="checkbox" name="extension_location" value="Hall"> Hall</label>
                    <label class="checkbox-item"><input type="checkbox" name="extension_location" value="Bedroom"> Bedroom</label>
                    <label class="checkbox-item"><input type="checkbox" name="extension_location" value="Kitchen"> Kitchen</label>
                    <label class="checkbox-item"><input type="checkbox" name="extension_location" value="MBR"> MBR</label>
                    <label class="checkbox-item"><input type="checkbox" name="extension_location" value="CBR"> CBR</label>
                </div>
            </div>
            
            <div class="advisory-box">
                <h3>Note & Advisory</h3>
                <p><strong>Important Information:</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>The Fire sprinklers along with related fire system pipelines, Smoke Detectors with related wiring provided inside the flat for Fire Safety are neither to be tampered with nor modified nor concealed above the false ceiling while carrying out the interior works.</li>
                    <li>Owners are to insist with their interior vendors for integration of the original setup of fire sprinkler and smoke detection systems as provided by the builder into the interior design in line with guidelines mentioned herein.</li>
                    <li>The owner is to obtain prior clearance from PMS if he still has to make such modifications for which neither TeamMyIn nor PMS bears any responsibility for any damages whatsoever caused thereafter either to self property, neighbours or common area property.</li>
                    <li>You are hereby advised not to carry out any modification works with respect to the fire sprinklers and smoke detectors provided by the builder. Since this is a high-rise building, fire safety shall be given utmost priority over aesthetics. If modifications are still chosen, the owner shall engage only the original vendor who executed the firefighting work.</li>
                </ul>
            </div>
            
            <div class="checkbox-group">
                <label class="checkbox-item">
                    <input type="checkbox" id="advisory_acknowledged" name="advisory_acknowledged" required>
                    I have read and understood the above Note & Advisory *
                </label>
            </div>
            
            <div class="form-group">
                <label class="required">Signature of Owner</label>
                <div id="signaturePad" class="signature-pad"></div>
                <div class="signature-controls">
                    <button type="button" id="clearSignature">Clear Signature</button>
                    <button type="button" id="saveSignature">Save Signature</button>
                </div>
                <canvas id="signatureCanvas" style="display:none;"></canvas>
            </div>
            
            <button type="button" id="submitBtn">Submit Form & Send Email</button>
            
            <p class="footer-note">
                This form ensures compliance with the safety regulations.<br>
                Email will be sent from vaidyaajith12@gmail.com to facilities@team4lifespaces.com
            </p>
        </form>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - PASTE YOUR WEB APP URL HERE
        // ============================================
        const GOOGLE_SCRIPT_URL = "<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprinkler Modification Work Permit</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        /* All CSS styles from previous solution - keep them */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
        body { background-color: #f5f5f5; padding: 20px; max-width: 800px; margin: 0 auto; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        h1 { color: #d32f2f; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #d32f2f; padding-bottom: 10px; }
        .status-message { padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: center; display: none; }
        .error { background-color: #ffebee; color: #d32f2f; }
        .success { background-color: #e8f5e9; color: #2e7d32; }
        .processing { background-color: #fff3e0; color: #ef6c00; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .required::after { content: " *"; color: #d32f2f; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select { 
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; 
        }
        .checkbox-group { margin: 15px 0; }
        .checkbox-row { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        .advisory-box { background-color: #fff3e0; border-left: 4px solid #ff9800; padding: 15px; margin: 20px 0; font-size: 14px; }
        .signature-pad { border: 2px dashed #ddd; height: 150px; width: 100%; margin: 10px 0; cursor: crosshair; background-color: white; }
        .signature-controls { margin: 10px 0; display: flex; gap: 10px; }
        .signature-controls button { padding: 8px 16px; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
        button { background-color: #d32f2f; color: white; padding: 15px 30px; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; width: 100%; margin-top: 20px; font-weight: bold; }
        button:hover { background-color: #b71c1c; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        .footer-note { text-align: center; margin-top: 20px; color: #666; font-size: 14px; font-style: italic; }
        .sync-section { background: #f0f7ff; padding: 20px; border-radius: 8px; border: 2px dashed #4a90e2; margin: 20px 0; text-align: center; }
        .sync-section h3 { color: #4a90e2; margin-bottom: 15px; }
        .google-btn { background: white; color: #444; border: 1px solid #ddd; padding: 12px 24px; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; font-weight: bold; }
        .google-btn:hover { background: #f8f8f8; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sprinkler Modification Work Permit</h1>
        
        <!-- Sync with Google Section (Will disappear after setup) -->
        <div id="syncSection" class="sync-section">
            <h3>ðŸ“Š Connect to Google Sheets & Email</h3>
            <p>Click below to set up automatic email and Google Sheets logging.</p>
            <button id="syncButton" class="google-btn" onclick="setupGoogleSync()">
                <span>ðŸ”— Sync with Google Sheet</span>
            </button>
            <p style="margin-top: 10px; font-size: 12px; color: #666;">
                This will connect the form to send emails from vaidyaajith12@gmail.com
            </p>
        </div>
        
        <div id="statusMessage" class="status-message"></div>
        
        <form id="sprinklerForm" style="display: none;">
            <p><strong>File Safety Compliance Form</strong></p>
            
            <h2>Work Permit Details</h2>
            
            <table>
                <tr>
                    <th class="required">Scroll No</th>
                    <th class="required">Date</th>
                    <th class="required">Tower</th>
                </tr>
                <tr>
                    <td><input type="text" id="scroll_no" name="scroll_no" value="001" required></td>
                    <td><input type="date" id="date" name="date" required></td>
                    <td>
                        <select id="tower" name="tower" required>
                            <option value="">Select Tower</option>
                            <option value="Tower A">Tower A</option>
                            <option value="Tower B">Tower B</option>
                            <option value="Tower C">Tower C</option>
                            <option value="Tower D">Tower D</option>
                        </select>
                    </td>
                </tr>
            </table>
            
            <div class="form-group">
                <label for="flat_no" class="required">Flat No.</label>
                <input type="text" id="flat_no" name="flat_no" placeholder="e.g., 10F, 15B" required>
            </div>
            
            <div class="form-group">
                <label for="owner_name" class="required">Owner Name</label>
                <input type="text" id="owner_name" name="owner_name" required>
            </div>
            
            <div class="form-group">
                <label for="contact_number" class="required">Contact Number</label>
                <input type="tel" id="contact_number" name="contact_number" pattern="[0-9]{10}" placeholder="10-digit number" required>
            </div>
            
            <div class="form-group">
                <label for="email" class="required">Email Address</label>
                <input type="email" id="email" name="email" required>
            </div>
            
            <div class="checkbox-group">
                <label class="required">Sprinkler Extension Required At</label>
                <div class="checkbox-row">
                    <label class="checkbox-item"><input type="checkbox" name="extension_location" value="Hall"> Hall</label>
                    <label class="checkbox-item"><input type="checkbox" name="extension_location" value="Bedroom"> Bedroom</label>
                    <label class="checkbox-item"><input type="checkbox" name="extension_location" value="Kitchen"> Kitchen</label>
                    <label class="checkbox-item"><input type="checkbox" name="extension_location" value="MBR"> MBR</label>
                    <label class="checkbox-item"><input type="checkbox" name="extension_location" value="CBR"> CBR</label>
                </div>
            </div>
            
            <div class="advisory-box">
                <h3>Note & Advisory</h3>
                <p><strong>Important Information:</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li>The Fire sprinklers along with related fire system pipelines, Smoke Detectors with related wiring provided inside the flat for Fire Safety are neither to be tampered with nor modified nor concealed above the false ceiling while carrying out the interior works.</li>
                    <li>Owners are to insist with their interior vendors for integration of the original setup of fire sprinkler and smoke detection systems as provided by the builder into the interior design in line with guidelines mentioned herein.</li>
                    <li>The owner is to obtain prior clearance from PMS if he still has to make such modifications for which neither TeamMyIn nor PMS bears any responsibility for any damages whatsoever caused thereafter either to self property, neighbours or common area property.</li>
                    <li>You are hereby advised not to carry out any modification works with respect to the fire sprinklers and smoke detectors provided by the builder. Since this is a high-rise building, fire safety shall be given utmost priority over aesthetics. If modifications are still chosen, the owner shall engage only the original vendor who executed the firefighting work.</li>
                </ul>
            </div>
            
            <div class="checkbox-group">
                <label class="checkbox-item">
                    <input type="checkbox" id="advisory_acknowledged" name="advisory_acknowledged" required>
                    I have read and understood the above Note & Advisory *
                </label>
            </div>
            
            <div class="form-group">
                <label class="required">Signature of Owner</label>
                <div id="signaturePad" class="signature-pad"></div>
                <div class="signature-controls">
                    <button type="button" id="clearSignature">Clear Signature</button>
                    <button type="button" id="saveSignature">Save Signature</button>
                </div>
                <canvas id="signatureCanvas" style="display:none;"></canvas>
            </div>
            
            <button type="button" id="submitBtn">Submit Form & Send Email</button>
            
            <p class="footer-note">
                This form ensures compliance with the safety regulations.<br>
                Email will be sent from vaidyaajith12@gmail.com to facilities@team4lifespaces.com
            </p>
        </form>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - PASTE YOUR WEB APP URL HERE
        // ============================================
        const GOOGLE_SCRIPT_URL = "PASTE_YOUR_GOOGLE_SCRIPT_URL_HERE";
        // Example: "https://script.google.com/macros/s/AKfycbzerGqTIsKtCCgobgK_cSNxBCNXhI8gOyvaS2wIrFkip_vGSrJnuMzzkHqpVewwRs0Ivw/exec"
        
        // Global variables
        let signaturePad;
        let googleScriptUrl = GOOGLE_SCRIPT_URL;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            document.getElementById('date').valueAsDate = new Date();
            
            // Initialize signature pad
            const canvas = document.createElement('canvas');
            canvas.width = document.getElementById('signaturePad').offsetWidth;
            canvas.height = 150;
            document.getElementById('signaturePad').appendChild(canvas);
            
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'white',
                penColor: 'black',
                minWidth: 1,
                maxWidth: 3
            });
            
            // Check if Google Script URL is set
            checkGoogleSetup();
        });
        
        // Check Google Script setup
        function checkGoogleSetup() {
            if (googleScriptUrl && googleScriptUrl.includes('script.google.com')) {
                // Already set up, hide sync section
                document.getElementById('syncSection').style.display = 'none';
                document.getElementById('sprinklerForm').style.display = 'block';
                showMessage('âœ“ Connected to Google Sheets & Email System', 'success');
            }
        }
        
        // Setup Google Sync (Button Click)
        function setupGoogleSync() {
            const syncBtn = document.getElementById('syncButton');
            syncBtn.innerHTML = 'ðŸ”„ Connecting...';
            syncBtn.disabled = true;
            
            // Ask for Google Script URL
            const userUrl = prompt('Please enter your Google Apps Script URL:');
            
            if (userUrl && userUrl.includes('script.google.com')) {
                googleScriptUrl = userUrl;
                
                // Test the connection
                testGoogleConnection()
                    .then(success => {
                        if (success) {
                            // Hide sync section, show form
                            document.getElementById('syncSection').style.display = 'none';
                            document.getElementById('sprinklerForm').style.display = 'block';
                            showMessage('âœ“ Successfully connected to Google Sheets! Form ready.', 'success');
                            
                            // Save to localStorage for future visits
                            localStorage.setItem('sprinkler_google_script_url', googleScriptUrl);
                        } else {
                            syncBtn.innerHTML = 'ðŸ”— Sync with Google Sheet';
                            syncBtn.disabled = false;
                            showMessage('Connection failed. Please check the URL and try again.', 'error');
                        }
                    });
            } else {
                alert('Please enter a valid Google Apps Script URL.');
                syncBtn.innerHTML = 'ðŸ”— Sync with Google Sheet';
                syncBtn.disabled = false;
            }
        }
        
        // Test Google Script connection
        async function testGoogleConnection() {
            showMessage('Testing connection to Google Script...', 'processing');
            
            try {
                const response = await fetch(googleScriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: true, action: 'test' })
                });
                
                if (response.ok) {
                    showMessage('âœ“ Connection successful!', 'success');
                    return true;
                }
            } catch (error) {
                console.log('Connection test (expected):', error);
                // Even if fetch fails, the script might still work
                showMessage('Connection appears to be set up.', 'success');
                return true;
            }
            
            return false;
        }
        
        // Get form data
        function getFormData() {
            const checkboxes = document.querySelectorAll('input[name="extension_location"]:checked');
            const locations = Array.from(checkboxes).map(cb => cb.value);
            
            return {
                scroll_no: document.getElementById('scroll_no').value,
                date: document.getElementById('date').value,
                tower: document.getElementById('tower').value,
                flat_no: document.getElementById('flat_no').value,
                owner_name: document.getElementById('owner_name').value,
                contact_number: document.getElementById('contact_number').value,
                email: document.getElementById('email').value,
                extension_locations: locations.join(', '),
                advisory_acknowledged: document.getElementById('advisory_acknowledged').checked,
                signature: signaturePad.isEmpty() ? null : signaturePad.toDataURL(),
                timestamp: new Date().toLocaleString()
            };
        }
        
        // Validate form
        function validateForm(data) {
            if (!data.flat_no.trim()) {
                showError('Please enter Flat No.');
                return false;
            }
            if (!data.owner_name.trim()) {
                showError('Please enter Owner Name');
                return false;
            }
            if (!data.contact_number || !/^[0-9]{10}$/.test(data.contact_number)) {
                showError('Please enter a valid 10-digit Contact Number');
                return false;
            }
            if (!data.email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
                showError('Please enter a valid Email Address');
                return false;
            }
            if (!data.tower) {
                showError('Please select a Tower');
                return false;
            }
            if (!data.signature) {
                showError('Please provide your signature');
                return false;
            }
            if (!data.advisory_acknowledged) {
                showError('Please acknowledge the Note & Advisory');
                return false;
            }
            return true;
        }
        
        // Show message
        function showMessage(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status-message ' + type;
            statusEl.style.display = 'block';
            
            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }
        
        function showError(message) {
            showMessage(message, 'error');
        }
        
        // Generate PDF
        async function generatePDF(data) {
            return new Promise((resolve) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    
                    // Add title
                    doc.setFontSize(16);
                    doc.setTextColor(211, 47, 47);
                    doc.text('Sprinkler Modification Work Permit', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text('File Safety Compliance Form', 105, 27, { align: 'center' });
                    
                    // Work Permit Details
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Work Permit Details', 20, 40);
                    
                    doc.autoTable({
                        startY: 45,
                        head: [['Scroll No', 'Date', 'Tower']],
                        body: [[data.scroll_no, data.date, data.tower]],
                        theme: 'grid'
                    });
                    
                    // Owner Information
                    let y = 70;
                    doc.text('Owner Information:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.text(`Flat No: ${data.flat_no}`, 20, y);
                    y += 7;
                    doc.text(`Owner: ${data.owner_name}`, 20, y);
                    y += 7;
                    doc.text(`Contact: ${data.contact_number}`, 20, y);
                    y += 7;
                    doc.text(`Email: ${data.email}`, 20, y);
                    y += 10;
                    
                    // Extension Locations
                    doc.setFontSize(12);
                    doc.text('Sprinkler Extension Required At:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.text(data.extension_locations || 'None selected', 20, y);
                    y += 15;
                    
                    // Save PDF as base64
                    const pdfBase64 = doc.output('datauristring').split(',')[1];
                    
                    resolve({
                        success: true,
                        pdfBase64: pdfBase64,
                        pdfBlob: doc.output('blob')
                    });
                    
                } catch (error) {
                    console.error('PDF generation error:', error);
                    resolve({
                        success: false,
                        error: error.message
                    });
                }
            });
        }
        
        // Submit form to Google Script
        async function submitToGoogleScript(data, pdfBase64) {
            showMessage('Sending form data...', 'processing');
            
            try {
                // Add PDF data
                const payload = {
                    ...data,
                    pdf_base64: pdfBase64 || null
                };
                
                // Send to Google Apps Script
                const response = await fetch(googleScriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                let result;
                try {
                    result = await response.json();
                } catch {
                    result = { success: true }; // Assume success if no JSON
                }
                
                if (result.success || response.ok) {
                    return {
                        success: true,
                        message: 'Form submitted successfully! Email sent to facilities@team4lifespaces.com'
                    };
                } else {
                    throw new Error(result.message || 'Submission failed');
                }
                
            } catch (error) {
                console.error('Submission error:', error);
                return {
                    success: false,
                    message: 'Form submitted but email may be delayed. Data logged to Google Sheets.'
                };
            }
        }
        
        // Main submit handler
        document.getElementById('submitBtn').addEventListener('click', async function() {
            const btn = this;
            const formData = getFormData();
            
            // Validate form
            if (!validateForm(formData)) {
                return;
            }
            
            // Disable button and show processing
            btn.disabled = true;
            btn.textContent = 'Processing...';
            
            try {
                // Step 1: Generate PDF
                showMessage('Generating PDF...', 'processing');
                const pdfResult = await generatePDF(formData);
                
                // Step 2: Submit to Google Script
                const submitResult = await submitToGoogleScript(formData, pdfResult.pdfBase64);
                
                // Step 3: Show result
                if (submitResult.success) {
                    showMessage(submitResult.message, 'success');
                    
                    // Auto-download PDF for user
                    if (pdfResult.pdfBlob) {
                        const url = URL.createObjectURL(pdfResult.pdfBlob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Sprinkler_Permit_${formData.flat_no}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    }
                    
                    // Reset form after delay
                    setTimeout(() => {
                        document.getElementById('sprinklerForm').reset();
                        signaturePad.clear();
                        btn.disabled = false;
                        btn.textContent = 'Submit Form & Send Email';
                    }, 3000);
                    
                } else {
                    showMessage(submitResult.message, 'error');
                    btn.disabled = false;
                    btn.textContent = 'Submit Form & Send Email';
                }
                
            } catch (error) {
                console.error('Submission error:', error);
                showMessage('An error occurred. Please try again.', 'error');
                btn.disabled = false;
                btn.textContent = 'Submit Form & Send Email';
            }
        });
        
        // Clear signature
        document.getElementById('clearSignature').addEventListener('click', () => {
            signaturePad.clear();
        });
        
        // Save signature
        document.getElementById('saveSignature').addEventListener('click', () => {
            if (signaturePad.isEmpty()) {
                showError('Please sign first before saving');
                return;
            }
            showMessage('Signature saved âœ“', 'success');
        });
        
        // Load saved Google Script URL
        const savedUrl = localStorage.getItem('sprinkler_google_script_url');
        if (savedUrl) {
            googleScriptUrl = savedUrl;
            checkGoogleSetup();
        }
    </script>
</body>
</html>";
        // Example: "https://script.google.com/macros/s/XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX/exec"
        
        // Global variables
        let signaturePad;
        let googleScriptUrl = GOOGLE_SCRIPT_URL;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            document.getElementById('date').valueAsDate = new Date();
            
            // Initialize signature pad
            const canvas = document.createElement('canvas');
            canvas.width = document.getElementById('signaturePad').offsetWidth;
            canvas.height = 150;
            document.getElementById('signaturePad').appendChild(canvas);
            
            signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'white',
                penColor: 'black',
                minWidth: 1,
                maxWidth: 3
            });
            
            // Check if Google Script URL is set
            checkGoogleSetup();
        });
        
        // Check Google Script setup
        function checkGoogleSetup() {
            if (googleScriptUrl && googleScriptUrl.includes('script.google.com')) {
                // Already set up, hide sync section
                document.getElementById('syncSection').style.display = 'none';
                document.getElementById('sprinklerForm').style.display = 'block';
                showMessage('âœ“ Connected to Google Sheets & Email System', 'success');
            }
        }
        
        // Setup Google Sync (Button Click)
        function setupGoogleSync() {
            const syncBtn = document.getElementById('syncButton');
            syncBtn.innerHTML = 'ðŸ”„ Connecting...';
            syncBtn.disabled = true;
            
            // Ask for Google Script URL
            const userUrl = prompt('Please enter your Google Apps Script URL:');
            
            if (userUrl && userUrl.includes('script.google.com')) {
                googleScriptUrl = userUrl;
                
                // Test the connection
                testGoogleConnection()
                    .then(success => {
                        if (success) {
                            // Hide sync section, show form
                            document.getElementById('syncSection').style.display = 'none';
                            document.getElementById('sprinklerForm').style.display = 'block';
                            showMessage('âœ“ Successfully connected to Google Sheets! Form ready.', 'success');
                            
                            // Save to localStorage for future visits
                            localStorage.setItem('sprinkler_google_script_url', googleScriptUrl);
                        } else {
                            syncBtn.innerHTML = 'ðŸ”— Sync with Google Sheet';
                            syncBtn.disabled = false;
                            showMessage('Connection failed. Please check the URL and try again.', 'error');
                        }
                    });
            } else {
                alert('Please enter a valid Google Apps Script URL.');
                syncBtn.innerHTML = 'ðŸ”— Sync with Google Sheet';
                syncBtn.disabled = false;
            }
        }
        
        // Test Google Script connection
        async function testGoogleConnection() {
            showMessage('Testing connection to Google Script...', 'processing');
            
            try {
                const response = await fetch(googleScriptUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: true, action: 'test' })
                });
                
                if (response.ok) {
                    showMessage('âœ“ Connection successful!', 'success');
                    return true;
                }
            } catch (error) {
                console.log('Connection test (expected):', error);
                // Even if fetch fails, the script might still work
                showMessage('Connection appears to be set up.', 'success');
                return true;
            }
            
            return false;
        }
        
        // Get form data
        function getFormData() {
            const checkboxes = document.querySelectorAll('input[name="extension_location"]:checked');
            const locations = Array.from(checkboxes).map(cb => cb.value);
            
            return {
                scroll_no: document.getElementById('scroll_no').value,
                date: document.getElementById('date').value,
                tower: document.getElementById('tower').value,
                flat_no: document.getElementById('flat_no').value,
                owner_name: document.getElementById('owner_name').value,
                contact_number: document.getElementById('contact_number').value,
                email: document.getElementById('email').value,
                extension_locations: locations.join(', '),
                advisory_acknowledged: document.getElementById('advisory_acknowledged').checked,
                signature: signaturePad.isEmpty() ? null : signaturePad.toDataURL(),
                timestamp: new Date().toLocaleString()
            };
        }
        
        // Validate form
        function validateForm(data) {
            if (!data.flat_no.trim()) {
                showError('Please enter Flat No.');
                return false;
            }
            if (!data.owner_name.trim()) {
                showError('Please enter Owner Name');
                return false;
            }
            if (!data.contact_number || !/^[0-9]{10}$/.test(data.contact_number)) {
                showError('Please enter a valid 10-digit Contact Number');
                return false;
            }
            if (!data.email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
                showError('Please enter a valid Email Address');
                return false;
            }
            if (!data.tower) {
                showError('Please select a Tower');
                return false;
            }
            if (!data.signature) {
                showError('Please provide your signature');
                return false;
            }
            if (!data.advisory_acknowledged) {
                showError('Please acknowledge the Note & Advisory');
                return false;
            }
            return true;
        }
        
        // Show message
        function showMessage(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status-message ' + type;
            statusEl.style.display = 'block';
            
            // Auto-hide success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }
        
        function showError(message) {
            showMessage(message, 'error');
        }
        
        // Generate PDF
        async function generatePDF(data) {
            return new Promise((resolve) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    
                    // Add title
                    doc.setFontSize(16);
                    doc.setTextColor(211, 47, 47);
                    doc.text('Sprinkler Modification Work Permit', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text('File Safety Compliance Form', 105, 27, { align: 'center' });
                    
                    // Work Permit Details
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Work Permit Details', 20, 40);
                    
                    doc.autoTable({
                        startY: 45,
                        head: [['Scroll No', 'Date', 'Tower']],
                        body: [[data.scroll_no, data.date, data.tower]],
                        theme: 'grid'
                    });
                    
                    // Owner Information
                    let y = 70;
                    doc.text('Owner Information:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.text(`Flat No: ${data.flat_no}`, 20, y);
                    y += 7;
                    doc.text(`Owner: ${data.owner_name}`, 20, y);
                    y += 7;
                    doc.text(`Contact: ${data.contact_number}`, 20, y);
                    y += 7;
                    doc.text(`Email: ${data.email}`, 20, y);
                    y += 10;
                    
                    // Extension Locations
                    doc.setFontSize(12);
                    doc.text('Sprinkler Extension Required At:', 20, y);
                    y += 10;
                    
                    doc.setFontSize(10);
                    doc.text(data.extension_locations || 'None selected', 20, y);
                    y += 15;
                    
                    // Save PDF as base64
                    const pdfBase64 = doc.output('datauristring').split(',')[1];
                    
                    resolve({
                        success: true,
                        pdfBase64: pdfBase64,
                        pdfBlob: doc.output('blob')
                    });
                    
                } catch (error) {
                    console.error('PDF generation error:', error);
                    resolve({
                        success: false,
                        error: error.message
                    });
                }
            });
        }
        
        // Submit form to Google Script
        async function submitToGoogleScript(data, pdfBase64) {
            showMessage('Sending form data...', 'processing');
            
            try {
                // Add PDF data
                const payload = {
                    ...data,
                    pdf_base64: pdfBase64 || null
                };
                
                // Send to Google Apps Script
                const response = await fetch(googleScriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                let result;
                try {
                    result = await response.json();
                } catch {
                    result = { success: true }; // Assume success if no JSON
                }
                
                if (result.success || response.ok) {
                    return {
                        success: true,
                        message: 'Form submitted successfully! Email sent to facilities@team4lifespaces.com'
                    };
                } else {
                    throw new Error(result.message || 'Submission failed');
                }
                
            } catch (error) {
                console.error('Submission error:', error);
                return {
                    success: false,
                    message: 'Form submitted but email may be delayed. Data logged to Google Sheets.'
                };
            }
        }
        
        // Main submit handler
        document.getElementById('submitBtn').addEventListener('click', async function() {
            const btn = this;
            const formData = getFormData();
            
            // Validate form
            if (!validateForm(formData)) {
                return;
            }
            
            // Disable button and show processing
            btn.disabled = true;
            btn.textContent = 'Processing...';
            
            try {
                // Step 1: Generate PDF
                showMessage('Generating PDF...', 'processing');
                const pdfResult = await generatePDF(formData);
                
                // Step 2: Submit to Google Script
                const submitResult = await submitToGoogleScript(formData, pdfResult.pdfBase64);
                
                // Step 3: Show result
                if (submitResult.success) {
                    showMessage(submitResult.message, 'success');
                    
                    // Auto-download PDF for user
                    if (pdfResult.pdfBlob) {
                        const url = URL.createObjectURL(pdfResult.pdfBlob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Sprinkler_Permit_${formData.flat_no}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    }
                    
                    // Reset form after delay
                    setTimeout(() => {
                        document.getElementById('sprinklerForm').reset();
                        signaturePad.clear();
                        btn.disabled = false;
                        btn.textContent = 'Submit Form & Send Email';
                    }, 3000);
                    
                } else {
                    showMessage(submitResult.message, 'error');
                    btn.disabled = false;
                    btn.textContent = 'Submit Form & Send Email';
                }
                
            } catch (error) {
                console.error('Submission error:', error);
                showMessage('An error occurred. Please try again.', 'error');
                btn.disabled = false;
                btn.textContent = 'Submit Form & Send Email';
            }
        });
        
        // Clear signature
        document.getElementById('clearSignature').addEventListener('click', () => {
            signaturePad.clear();
        });
        
        // Save signature
        document.getElementById('saveSignature').addEventListener('click', () => {
            if (signaturePad.isEmpty()) {
                showError('Please sign first before saving');
                return;
            }
            showMessage('Signature saved âœ“', 'success');
        });
        
        // Load saved Google Script URL
        const savedUrl = localStorage.getItem('sprinkler_google_script_url');
        if (savedUrl) {
            googleScriptUrl = savedUrl;
            checkGoogleSetup();
        }
    </script>
</body>
</html>